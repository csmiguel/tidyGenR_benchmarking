<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Miguel Camacho Sánchez">

<title>tidyGenR benchmarking</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="benchmarking_files/libs/clipboard/clipboard.min.js"></script>
<script src="benchmarking_files/libs/quarto-html/quarto.js"></script>
<script src="benchmarking_files/libs/quarto-html/popper.min.js"></script>
<script src="benchmarking_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="benchmarking_files/libs/quarto-html/anchor.min.js"></script>
<link href="benchmarking_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="benchmarking_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="benchmarking_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="benchmarking_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="benchmarking_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#benchmarking-tidygenr" id="toc-benchmarking-tidygenr" class="nav-link active" data-scroll-target="#benchmarking-tidygenr">Benchmarking <em>tidyGenR</em></a></li>
  <li><a href="#preparation-of-input-data" id="toc-preparation-of-input-data" class="nav-link" data-scroll-target="#preparation-of-input-data">Preparation of input data</a></li>
  <li><a href="#demultiplex-by-locus" id="toc-demultiplex-by-locus" class="nav-link" data-scroll-target="#demultiplex-by-locus">Demultiplex by locus</a></li>
  <li><a href="#truncate-reads" id="toc-truncate-reads" class="nav-link" data-scroll-target="#truncate-reads">Truncate reads</a></li>
  <li><a href="#exploration-of-the-parameter-space" id="toc-exploration-of-the-parameter-space" class="nav-link" data-scroll-target="#exploration-of-the-parameter-space">Exploration of the parameter space</a></li>
  <li><a href="#variant-and-genotype-calling" id="toc-variant-and-genotype-calling" class="nav-link" data-scroll-target="#variant-and-genotype-calling">Variant and genotype calling</a></li>
  <li><a href="#tidy-data" id="toc-tidy-data" class="nav-link" data-scroll-target="#tidy-data">Tidy data</a></li>
  <li><a href="#tidygenr-vs-amplisas" id="toc-tidygenr-vs-amplisas" class="nav-link" data-scroll-target="#tidygenr-vs-amplisas"><em>tidyGenR</em> vs AmpliSAS</a></li>
  <li><a href="#integration-of-alleles-with-publised-data" id="toc-integration-of-alleles-with-publised-data" class="nav-link" data-scroll-target="#integration-of-alleles-with-publised-data">Integration of alleles with publised data</a></li>
  <li><a href="#session-info" id="toc-session-info" class="nav-link" data-scroll-target="#session-info">session info</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">tidyGenR benchmarking</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Miguel Camacho Sánchez </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<p>Attach libraries:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyGenR)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">

</div>
<section id="benchmarking-tidygenr" class="level2">
<h2 class="anchored" data-anchor-id="benchmarking-tidygenr">Benchmarking <em>tidyGenR</em></h2>
<p>This repository accompanies the R package <strong>tidyGenR</strong> available at <a href="https://github.com/csmiguel/tidyGenR" class="uri">https://github.com/csmiguel/tidyGenR</a>. It covers (1) all steps for genotype calling with <em>tidyGenR</em>, (2) exploration of the parameters for variant calling, and (3) comparison of <em>tidyGenR</em> against <a href="https://doi.org/10.1111/1755-0998.12453">AmpliSAS</a>. It uses real data from a population genetics study of the wild rodent <em>Rattus baluensis</em> (Camacho-Sanchez et al.&nbsp;<em>in preparation</em>).</p>
</section>
<section id="preparation-of-input-data" class="level2">
<h2 class="anchored" data-anchor-id="preparation-of-input-data">Preparation of input data</h2>
<p>Raw sequences are deposited in NCBI under the BioStudy <a href="https://trace.ncbi.nlm.nih.gov/Traces/study/?acc=SRP293699">SRP293699</a>, in the BioProject <a href="https://www.ncbi.nlm.nih.gov/bioproject/PRJNA680166">PRJNA680166</a>. From the BioStudy, we can download the <a href="data/raw/SraRunTable.csv">SRA metadata</a> to map sample IDs to SRRs:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># table with mapped SRR-sampleIDs</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>srr <span class="ot">&lt;-</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read.csv</span>(<span class="st">"data/raw/SraRunTable.csv"</span>) <span class="sc">|&gt;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Run, <span class="st">"Sample.Name"</span>) <span class="sc">|&gt;</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">run =</span> Run,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">sample =</span> <span class="st">"Sample.Name"</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="fu">head</span>(srr, <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;">run</th>
<th style="text-align: left;">sample</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">SRR13106799</td>
<td style="text-align: left;">BOR1063</td>
</tr>
<tr class="even">
<td style="text-align: left;">SRR13106800</td>
<td style="text-align: left;">BOR1061</td>
</tr>
<tr class="odd">
<td style="text-align: left;">SRR13106802</td>
<td style="text-align: left;">BOR626</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The FASTQ reads from the SRRs can be downloaded with <a href="https://github.com/ncbi/sra-tools">SRA-toolkit</a>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># download raw reads from NCBI</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># they are not downloaded if already present in 'data/raw'.</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(srr, <span class="dv">1</span>, <span class="cf">function</span>(x) {</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># name paths</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  srr_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">"data/raw"</span>, x[<span class="dv">1</span>])</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  srr1 <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">"data/raw"</span>, <span class="fu">paste0</span>(x[<span class="dv">1</span>], <span class="st">"_1.fastq"</span>))</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  srr2 <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">"data/raw"</span>, <span class="fu">paste0</span>(x[<span class="dv">1</span>], <span class="st">"_2.fastq"</span>))</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  sam1 <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">"data/raw"</span>, <span class="fu">paste0</span>(x[<span class="dv">2</span>], <span class="st">"_1.fastq"</span>))</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  sam2 <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">"data/raw"</span>, <span class="fu">paste0</span>(x[<span class="dv">2</span>], <span class="st">"_2.fastq"</span>))</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fetch SRR</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">any</span>(<span class="fu">dir.exists</span>(srr_path) <span class="sc">||</span> <span class="fu">file.exists</span>(sam1))) {</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">system2</span>(<span class="st">"prefetch"</span>, <span class="fu">paste</span>(<span class="st">"-O"</span>, <span class="st">"data/raw/"</span>, x[<span class="dv">1</span>]))</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># reformat to FASTQ</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(sam1)) {</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">system2</span>(<span class="st">"fasterq-dump"</span>, <span class="fu">paste</span>(<span class="st">"-O"</span>, <span class="st">"data/raw/"</span>, srr_path))</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">system2</span>(<span class="st">"mv"</span>, <span class="fu">paste</span>(srr1, sam1))</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">system2</span>(<span class="st">"mv"</span>, <span class="fu">paste</span>(srr2, sam2))</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># rm SRR</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">system2</span>(<span class="st">"rm"</span>, <span class="fu">paste0</span>(<span class="st">"-r "</span>, srr_path, <span class="st">"*"</span>))</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>  })</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NULL</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># glimpse raw FASTQ</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">list.files</span>(<span class="st">"data/raw"</span>, <span class="at">pattern =</span> <span class="st">"fastq"</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "BOR1061_1.fastq" "BOR1061_2.fastq" "BOR1063_1.fastq"</code></pre>
</div>
</div>
<p>Check input data files:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>freads <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">"data/raw"</span>, <span class="at">pattern =</span> <span class="st">"1.fastq"</span>,</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>rreads <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">"data/raw"</span>, <span class="at">pattern =</span> <span class="st">"2.fastq"</span>,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>chr <span class="ot">&lt;-</span> <span class="fu">check_raw_reads</span>(freads, rreads, <span class="at">low_readcount =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>All F and (R files) passed check on number of reads above 10.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Sample names are unique.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>All F files have their corresponding R file.</code></pre>
</div>
</div>
<p>Input FASTQ is conditions for <em>tidyGenR</em>. A total of 44 are detected:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>chr<span class="sc">$</span>samples</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "BOR1061" "BOR1063" "BOR1069" "BOR1070" "BOR1071" "BOR1074" "BOR1075"
 [8] "BOR1076" "BOR1077" "BOR1079" "BOR1080" "BOR1082" "BOR1086" "BOR1088"
[15] "BOR1090" "BOR1091" "BOR1097" "BOR1098" "BOR1101" "BOR1107" "BOR1111"
[22] "BOR1113" "BOR1115" "BOR1125" "BOR1127" "BOR1129" "BOR1131" "BOR1133"
[29] "BOR1135" "BOR1137" "BOR1139" "BOR1141" "BOR1143" "BOR1147" "BOR1149"
[36] "BOR1151" "BOR1155" "BOR614"  "BOR615"  "BOR616"  "BOR618"  "BOR619" 
[43] "BOR621"  "BOR626" </code></pre>
</div>
</div>
</section>
<section id="demultiplex-by-locus" class="level2">
<h2 class="anchored" data-anchor-id="demultiplex-by-locus">Demultiplex by locus</h2>
<p>Reads are demultiplexed by locus using primer sequences in paired-end mode.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load primer data</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"primers"</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="co"># path to cutadapt</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>cutadapt <span class="ot">&lt;-</span> <span class="fu">system</span>(<span class="st">"which cutadapt"</span>, <span class="at">intern =</span> <span class="cn">TRUE</span>)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co"># path to folder save locus-demultiplexed FASTQ</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>demult <span class="ot">&lt;-</span> <span class="st">"data/intermediate/demultiplexed"</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="co"># print primers</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="fu">head</span>(primers, <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;">locus</th>
<th style="text-align: left;">fw</th>
<th style="text-align: left;">rv</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">nfkbia</td>
<td style="text-align: left;">GCCTCCAAACACACAGTCAT</td>
<td style="text-align: left;">TGAGGAGAGCTATGACACGG</td>
</tr>
<tr class="even">
<td style="text-align: left;">chrna9</td>
<td style="text-align: left;">TTATCTGGGAGAGCGTGACC</td>
<td style="text-align: left;">TTGGGAAARGATGAACCGGC</td>
</tr>
<tr class="odd">
<td style="text-align: left;">rogdi</td>
<td style="text-align: left;">AGAARCCGGCTCACTACCC</td>
<td style="text-align: left;">GAGGCACAGCTTGTTGAGG</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># demultiplex</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">demultiplex</span>(</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">interpreter =</span> <span class="st">"/bin/bash"</span>,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">cutadapt =</span> cutadapt,</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">freads =</span> freads,</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">rreads =</span> rreads,</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">primers =</span> primers,</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">sh_out =</span> <span class="st">"code/demultiplex.sh"</span>,</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">write_demultiplexed =</span> demult,</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">log_out =</span> c_log,</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">mode =</span> <span class="st">"pe"</span>,</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">run =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># glimpse demultiplexed FASTQ</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">list.files</span>(demult, <span class="at">pattern =</span> <span class="st">"fastq"</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "BOR1061.abcg8.1.fastq.gz"  "BOR1061.abcg8.2.fastq.gz" 
[3] "BOR1061.alkbh7.1.fastq.gz"</code></pre>
</div>
</div>
<p>Remove files with few reads:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">remove_poor_fastq</span>(demult,</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>                   <span class="at">min_reads =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="truncate-reads" class="level2">
<h2 class="anchored" data-anchor-id="truncate-reads">Truncate reads</h2>
<p>Reads are truncated to a given length for each locus. A <code>data.frame</code> with truncation lengths for forward and reverse reads was built to maximize the amount of information yielded by each locus. For instance, the amplicons for some loci, as <em>nfkbia</em>, are long and it is a good trade-off to leave the low quality ends in but to be sure both F and R reads overlap.</p>
<p>Building of <code>data.frame</code> with locus-specific truncation lengths:</p>
<p>Truncate reads according to locus-specific truncation lengths:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>tr_dir <span class="ot">&lt;-</span> <span class="st">"data/intermediate/truncated"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># truncate</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>trunc_out <span class="ot">&lt;-</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">trunc_amp</span>(<span class="at">in_dir =</span> demult,</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">fw_pattern =</span> <span class="st">"1.fastq.gz"</span>,</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">rv_pattern =</span> <span class="st">"2.fastq.gz"</span>,</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>          <span class="at">trunc_fr =</span> trunc_fr,</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>          <span class="at">write_trun =</span> tr_dir,</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>          <span class="at">max_ee =</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">5</span>),</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>          <span class="at">trunc_q =</span> <span class="dv">2</span>)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="co"># save reads in and out</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(trunc_out, tr_path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The output from <code>trunc_amp()</code> is a list of matrices with IN and OUT reads after truncation:</p>
<div class="cell">
<div class="cell-output cell-output-stderr">
<pre><code>0 files removed:</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># see trunc_out</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(trunc_out[<span class="fu">seq_len</span>(<span class="dv">3</span>)], head, <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$abcg8
        reads.in reads.out
BOR1061     1716      1039
BOR1063     1616       992
BOR1069     1634       961

$alkbh7
        reads.in reads.out
BOR1061      546       398
BOR1063      499       361
BOR1069      546       374

$apeh17
        reads.in reads.out
BOR1061     3719      2773
BOR1063     3761      2793
BOR1069     3756      2838</code></pre>
</div>
</div>
</section>
<section id="exploration-of-the-parameter-space" class="level2">
<h2 class="anchored" data-anchor-id="exploration-of-the-parameter-space">Exploration of the parameter space</h2>
<p>The function <code>explore_dada()</code> can be used to explore the effect of DADA2 parameters (“OMEGA_A”, “BAND_SIZE”, “pool”) on the sensitivity on the variant calling.</p>
<ul>
<li><em>omega_a</em>: threshold for variants to be significant overabundant <em>log(-log(birth_pval))</em> (see <a href="https://doi.org/10.1186/1471-2105-13-283.">Rosen et al.&nbsp;2012</a>).</li>
<li><em>band_size</em>: positive numbers set a band size in Needleman-Wunsch alignments. In this context, ends free alignment is performed. A value of zero turns off banding, triggering full Needleman-Wunsch alignments, in which gapless alignment is performed (see <a href="https://github.com/benjjneb/dada2/issues/1982">issue</a>).</li>
<li><em>pool</em>: calling variants pooling samples can increase sensitivity (see <a href="https://benjjneb.github.io/dada2/pseudo.html">dicussion</a>).</li>
</ul>
<p>The returned plots can be used to guide the election of the best <em>OMEGA_A</em> in <code>variant_call()</code>, or frequency (<em>maf</em>) and abundance thresholds (<em>ad</em>) for filtering variants.</p>
<p>Explore variants:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># declare candidate OMEGA_A to use in variant_call()</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>candidate_omega_a <span class="ot">&lt;-</span> <span class="dv">10</span><span class="sc">^-</span><span class="dv">2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># paths to forward and reverse truncated reads</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>ftrun <span class="ot">&lt;-</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list.files</span>(tr_dir, <span class="at">pattern =</span> <span class="st">"_F_"</span>, <span class="at">full.names =</span> T)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>rtrun <span class="ot">&lt;-</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list.files</span>(tr_dir, <span class="at">pattern =</span> <span class="st">"_R_"</span>, <span class="at">full.names =</span> T)</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="co"># candidate omegavalue to annotate vline in plots.</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>v_line <span class="ot">&lt;-</span> <span class="fu">log</span>(<span class="sc">-</span><span class="fu">log</span>(candidate_omega_a))</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="co"># run explore_dada() with band_size = 0, non pooling and omega_a = 0.9</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="co"># forward</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>F_ind_0 <span class="ot">&lt;-</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">explore_dada</span>(ftrun, <span class="at">band_size =</span> <span class="dv">0</span>, <span class="at">vline =</span> v_line, <span class="at">hline_fr =</span> <span class="fl">0.1</span>)</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="co"># reverse</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>R_ind_0 <span class="ot">&lt;-</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">explore_dada</span>(rtrun, <span class="at">band_size =</span> <span class="dv">0</span>, <span class="at">vline =</span> v_line, <span class="at">hline_fr =</span> <span class="fl">0.1</span>)</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="co"># save results</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(<span class="fu">list</span>(<span class="at">F_ind_0 =</span> F_ind_0, <span class="at">R_ind_0 =</span> R_ind_0), x_out_path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Exploration of DADA2 clustering for forward (A, C) and reverse (B, D) reads. The Y-axis represents the frequency of the variant in each locus and sample. The <em>log(-log(birth_pval))</em> transformation in the X-axis is related to the p-value of a variant being significantly overabundant. Larger x-values represent likely true variants. For representation purposes <em>birth_pval</em> of 0 (thus negative infinite), are converted to 10. Points are color-coded according to the variant rank in read abundance for its given locus and sample. For diploid individuals, <span style="color: green;">green</span> are likely true variants and <span style="color: red;">red</span> are likely false variants. <span style="color: grey;">Grey</span> dashed lines are thresholds used for <code>variant_call()</code>:</p>
<div class="cell">

</div>
<div class="cell" data-warnings="false">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>ppool <span class="ot">&lt;-</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  (F_ind_0<span class="sc">$</span>p1 <span class="sc">|</span> R_ind_0<span class="sc">$</span>p1) <span class="sc">/</span> (F_ind_0<span class="sc">$</span>p2 <span class="sc">|</span> R_ind_0<span class="sc">$</span>p2) <span class="sc">+</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  patchwork<span class="sc">::</span><span class="fu">plot_annotation</span>(<span class="at">title =</span> <span class="st">"Dada F/R pool = F, omega_a 0.9, band_size = 0"</span>,</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>                             <span class="at">tag_levels =</span> <span class="st">"A"</span>)</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="co"># save plot with combined loci</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">"output/explore_dada.pdf"</span>, ppool, <span class="at">width =</span> <span class="dv">8</span>, <span class="at">height =</span> <span class="dv">5</span>)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="co"># print plot</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>ppool</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-explore_dada" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="benchmarking_files/figure-html/fig-explore_dada-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;1: Exploration of DADA2 variants</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>After the exploration variants in <a href="#fig-explore_dada">Figure&nbsp;1</a>, it seems an <em>OMEGA_A</em> = 0.01, implying a cutoff of 1.5271796 in the X-axis and a frequency threshold (Y-axis) of 0.1, excludes most <span style="color: red;">artifacts</span> while maximizing <span style="color: green;">true positives</span>.</p>
<p>The results can also be explored <strong>per-locus</strong>. For instance, <a href="#fig-explore_dada">Figure&nbsp;1</a> B can be expanded per locus as follows:</p>
<div class="cell" data-warnings="false">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>lplots<span class="sc">$</span>loci_r_ind_0_logp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-explore_dada_loci" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="benchmarking_files/figure-html/fig-explore_dada_loci-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;2: Exploration of DADA2 variants per locus for R reads</figcaption><p></p>
</figure>
</div>
</div>
</div>
</section>
<section id="variant-and-genotype-calling" class="level2">
<h2 class="anchored" data-anchor-id="variant-and-genotype-calling">Variant and genotype calling</h2>
<p>Variant calling is run using <em>OMEGA_A</em> = 0.01, and under different parameters:</p>
<ul>
<li><em>band_size</em>: 0, 16</li>
<li><em>pool</em>: TRUE, FALSE</li>
</ul>
<div class="cell">

</div>
<p>Variants are used to genotype individuals with defaults <code>ploidy = 2</code> and <code>ADt = 10</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>genotypes_x <span class="ot">&lt;-</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(variants_x, genotype)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(genotypes_x, <span class="at">file =</span> <span class="st">"output/genotypes_x.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">

</div>
</section>
<section id="tidy-data" class="level2">
<h2 class="anchored" data-anchor-id="tidy-data">Tidy data</h2>
<p>A strong point from <em>tidyGenR</em> is that variants and genotypes from <code>variant_call()</code> and <code>genotype()</code> are returned in <code>tidy</code> format: one row per observation and variables in columns. Lets have a look at the data structure.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># glimpse tidy variants</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="fu">head</span>(variants_x<span class="sc">$</span>ind_bs0))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 1%">
<col style="width: 1%">
<col style="width: 1%">
<col style="width: 1%">
<col style="width: 0%">
<col style="width: 6%">
<col style="width: 86%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">sample</th>
<th style="text-align: left;">locus</th>
<th style="text-align: left;">variant</th>
<th style="text-align: right;">reads</th>
<th style="text-align: right;">nt</th>
<th style="text-align: left;">md5</th>
<th style="text-align: left;">sequence</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">BOR1061</td>
<td style="text-align: left;">abcg8</td>
<td style="text-align: left;">01</td>
<td style="text-align: right;">1028</td>
<td style="text-align: right;">390</td>
<td style="text-align: left;">c3eab42bea56937040aa79a6bbea2724</td>
<td style="text-align: left;">TTGCCCACCCTGTTCATCCATGGAGCAGAAGCCTGCCTGATGTCTCTCATCATTGGCTTCCTTTACTACGGCCACGCAGATAAGCCGCTCTCCTTCGTGGACATGGCAGCCCTCCTGTTCATGATAGGAGCGCTCATTCCTTTTAATGTCATTCTGGATGTCGTCTCCAAATGTGAGTGTCACCCGCCCTCCTCACCAGACATCGGGACAGTGGGACAGCCTCCCTGGGCACTGCACTGAGGCCAAGCTCTGTGCTTCCGCTGGTACCCACGGCATTACAAGAGATGCGACCTCAGTAACACTCTTCGCTCATTCACCTCCCTCTCCCCCATCTCCAGGTCACTCGGAGCGCTCGCTGCTGTACTATGAACTGGAGGACGGACTGTACAC</td>
</tr>
<tr class="even">
<td style="text-align: left;">BOR1061</td>
<td style="text-align: left;">alkbh7</td>
<td style="text-align: left;">1</td>
<td style="text-align: right;">393</td>
<td style="text-align: right;">390</td>
<td style="text-align: left;">620057f2e547e688d1220db91a3a1d01</td>
<td style="text-align: left;">GCCTTCCTGGCCCCATCCCCTCTGGGAGGGAGCGGCAAATCACTGAGATGCGTCGGCCCCGGGGGACCCGGTGAGCCCCAAAAAATGATTCTTCATCTCTAAGGATCTCATGGGAGAAGTCATATCGGGCTGAACCCCTGCAAGAAAATAAAGGCCAAGTAGGTGAAGGGAGGGAAGTCTGTCCCTTCATCATTTCTGTACTTTATCTGGGTAGTGGTGATGGTGACTTCCTCTGCTATGAGAGCAGAAACAAGAGCTGTTGGAAACACTTGGCCTCATCTGGGGGTTCTAGGCTAGGTCATACCTTAGGATATAGAGAGAACCAGGTTCCAGCAACAGTTCCAGCCACTGCTCAGGTTCCTGTGTATGAACCAGCTTCATAACACTTGG</td>
</tr>
<tr class="odd">
<td style="text-align: left;">BOR1061</td>
<td style="text-align: left;">apeh17</td>
<td style="text-align: left;">1</td>
<td style="text-align: right;">2747</td>
<td style="text-align: right;">415</td>
<td style="text-align: left;">394a483d3ae2ce5605f1674b2400986c</td>
<td style="text-align: left;">AAAGCCAGTGGAGCCACGATAGTTCACTGCAAGTGAGACAAGATAGTCGGGCAATGTTCTCAGTCCCCAACCCAATTCCATGTGTCTGTGACATAGGCCCTAGGACCAGCTGCATCACGTGCTGTCAAGGGGAGGTAGCCAAGAGAGATGAAGCTGCTACCCTGAGACCACAGCATCCTTTCCACAGAAGCTTCAAGTTAATCCACGTGATCACCAGGTTATGAAGCCAGAGGCTAAGCCAGGGCAATTTCTAGTAGTAGTTTCTTTTTGTTTTCAAAACAGGGTTTTTCTGTGCAGTCCTGGATGATCTTGGACTCAAACCTTCACCTGCCTCTGCCTCCTAAGTGCTGGATTAAAGGAGTGTGCCCCCATTGCCCAGCCCGTTTCTAAAGAGTAAGTACACCATAGAAAAGCA</td>
</tr>
<tr class="even">
<td style="text-align: left;">BOR1061</td>
<td style="text-align: left;">cd27</td>
<td style="text-align: left;">01</td>
<td style="text-align: right;">1143</td>
<td style="text-align: right;">379</td>
<td style="text-align: left;">a897a500c934797d4b3662415fc92456</td>
<td style="text-align: left;">AGTCTTCCTGGATAGGGATGACGCTGCCCTCCTCCTCCCTGGGGCAGCTGTAAGGACAAAGCTCTTCAGGTACTGCCTGGCTATCTTCATCTGTGCAAAGACAATTAGCCAAGTGTTGGTCAGCAGTGGAGAGAAGAGAGGGGAAGGTGAGGAGAGAGGAGAAGGCCGAGTGGAGGCTGGGGCATGGGGGAGCCAGGGGAGCCTGTGGGAAGGACACTTGAAGAACCAGAGAAGGTGGGTGAAGGTGGGATGGGGGCTTTAGGTGTGGGTGGCAGAGCTGAGAGGGCAGGAGGGAAGGCCTGTGCCTTACTTGGCCCGTGATTTCTTCTTTGACGGAAGAACAAGATCCCACCCAGGACGAAGACAAGAAGCATGCTGG</td>
</tr>
<tr class="odd">
<td style="text-align: left;">BOR1061</td>
<td style="text-align: left;">chrna9</td>
<td style="text-align: left;">01</td>
<td style="text-align: right;">21</td>
<td style="text-align: right;">408</td>
<td style="text-align: left;">3d77c726462281336567895361ceebc1</td>
<td style="text-align: left;">TGCAGTGTGACATTCAGCACCGCGTCCGTATCCTCGACTGGACGCAGAGCACTGGAGTAGTCTTCAAAAAGATCGCTGAACAATTTCTGAGCATATTTCCCATTTGCTGTCTCTACGGCTGTTCAAAGAGAAGCACCCGGATGGGCATTTCAAAACAAGACCAACTCTGGGGTCAAAATGGGGGATGGCAACTTTGGATGAGTTCTTTTTTGGGGGCAGGGGACTGGTCTTACCTACCTTGATGATCGAGAGTCAGAAAGAGGTGCGAGCACGCCCATGTACTCACGTCAGTCCTCCTGTCTCTCTCACCAAGGCTCTAAGGAGCCTCTATGGAGCACTGCGCTAGCCCCTCACCTCTGATTCCAGAAGCAGCAAAATACATCCAGCAAAAGGAGATGCAGGACTGGG</td>
</tr>
<tr class="even">
<td style="text-align: left;">BOR1061</td>
<td style="text-align: left;">chrna9</td>
<td style="text-align: left;">02</td>
<td style="text-align: right;">27</td>
<td style="text-align: right;">408</td>
<td style="text-align: left;">9b805048a29d6233f1ac41f2a6aa1421</td>
<td style="text-align: left;">TGCAGTGTGACATTCAGCACCGCGTCCGTATCCTCGACTGGACGCAGAGCACTGGAGTAGTCTTCAAAAAGATCGCTGAATAATTTCTGAGCATATTTCCCATTTGCTGTCTCTACGGCTGTTCAAAGAGAAGCACCCGGATGGGCATTTCAAAACAAGACCAACTCTGGGATCAAAATGGGGGATGGCAACTTTGGATGAGTTCTTTTTTGGGGGCAGGGGACTGGTCTTACCTACCTTGATGATCAAGAGTCAGAAAGAGGTGCGAGCACGCCCATGTACTCACGTCAGTCCTCCTGTCTCTCTCACCAAGGCTCTAAGGAGCCTCTATGGAGCACTGCGCTAGCCCCTCACCTCTGATTCCAGAAGCAGCAAAATACATCCAGCAAAAGGAGATGCAGGACTGGG</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># glimpse tidy genotypes</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="fu">head</span>(genotypes_x<span class="sc">$</span>ind_bs0))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 1%">
<col style="width: 1%">
<col style="width: 1%">
<col style="width: 2%">
<col style="width: 1%">
<col style="width: 0%">
<col style="width: 6%">
<col style="width: 84%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">sample</th>
<th style="text-align: left;">locus</th>
<th style="text-align: left;">allele</th>
<th style="text-align: right;">allele_no</th>
<th style="text-align: right;">reads</th>
<th style="text-align: right;">nt</th>
<th style="text-align: left;">md5</th>
<th style="text-align: left;">sequence</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">BOR1061</td>
<td style="text-align: left;">abcg8</td>
<td style="text-align: left;">01</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">514.0</td>
<td style="text-align: right;">390</td>
<td style="text-align: left;">c3eab42bea56937040aa79a6bbea2724</td>
<td style="text-align: left;">TTGCCCACCCTGTTCATCCATGGAGCAGAAGCCTGCCTGATGTCTCTCATCATTGGCTTCCTTTACTACGGCCACGCAGATAAGCCGCTCTCCTTCGTGGACATGGCAGCCCTCCTGTTCATGATAGGAGCGCTCATTCCTTTTAATGTCATTCTGGATGTCGTCTCCAAATGTGAGTGTCACCCGCCCTCCTCACCAGACATCGGGACAGTGGGACAGCCTCCCTGGGCACTGCACTGAGGCCAAGCTCTGTGCTTCCGCTGGTACCCACGGCATTACAAGAGATGCGACCTCAGTAACACTCTTCGCTCATTCACCTCCCTCTCCCCCATCTCCAGGTCACTCGGAGCGCTCGCTGCTGTACTATGAACTGGAGGACGGACTGTACAC</td>
</tr>
<tr class="even">
<td style="text-align: left;">BOR1061</td>
<td style="text-align: left;">abcg8</td>
<td style="text-align: left;">01</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">514.0</td>
<td style="text-align: right;">390</td>
<td style="text-align: left;">c3eab42bea56937040aa79a6bbea2724</td>
<td style="text-align: left;">TTGCCCACCCTGTTCATCCATGGAGCAGAAGCCTGCCTGATGTCTCTCATCATTGGCTTCCTTTACTACGGCCACGCAGATAAGCCGCTCTCCTTCGTGGACATGGCAGCCCTCCTGTTCATGATAGGAGCGCTCATTCCTTTTAATGTCATTCTGGATGTCGTCTCCAAATGTGAGTGTCACCCGCCCTCCTCACCAGACATCGGGACAGTGGGACAGCCTCCCTGGGCACTGCACTGAGGCCAAGCTCTGTGCTTCCGCTGGTACCCACGGCATTACAAGAGATGCGACCTCAGTAACACTCTTCGCTCATTCACCTCCCTCTCCCCCATCTCCAGGTCACTCGGAGCGCTCGCTGCTGTACTATGAACTGGAGGACGGACTGTACAC</td>
</tr>
<tr class="odd">
<td style="text-align: left;">BOR1061</td>
<td style="text-align: left;">alkbh7</td>
<td style="text-align: left;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">196.5</td>
<td style="text-align: right;">390</td>
<td style="text-align: left;">620057f2e547e688d1220db91a3a1d01</td>
<td style="text-align: left;">GCCTTCCTGGCCCCATCCCCTCTGGGAGGGAGCGGCAAATCACTGAGATGCGTCGGCCCCGGGGGACCCGGTGAGCCCCAAAAAATGATTCTTCATCTCTAAGGATCTCATGGGAGAAGTCATATCGGGCTGAACCCCTGCAAGAAAATAAAGGCCAAGTAGGTGAAGGGAGGGAAGTCTGTCCCTTCATCATTTCTGTACTTTATCTGGGTAGTGGTGATGGTGACTTCCTCTGCTATGAGAGCAGAAACAAGAGCTGTTGGAAACACTTGGCCTCATCTGGGGGTTCTAGGCTAGGTCATACCTTAGGATATAGAGAGAACCAGGTTCCAGCAACAGTTCCAGCCACTGCTCAGGTTCCTGTGTATGAACCAGCTTCATAACACTTGG</td>
</tr>
<tr class="even">
<td style="text-align: left;">BOR1061</td>
<td style="text-align: left;">alkbh7</td>
<td style="text-align: left;">1</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">196.5</td>
<td style="text-align: right;">390</td>
<td style="text-align: left;">620057f2e547e688d1220db91a3a1d01</td>
<td style="text-align: left;">GCCTTCCTGGCCCCATCCCCTCTGGGAGGGAGCGGCAAATCACTGAGATGCGTCGGCCCCGGGGGACCCGGTGAGCCCCAAAAAATGATTCTTCATCTCTAAGGATCTCATGGGAGAAGTCATATCGGGCTGAACCCCTGCAAGAAAATAAAGGCCAAGTAGGTGAAGGGAGGGAAGTCTGTCCCTTCATCATTTCTGTACTTTATCTGGGTAGTGGTGATGGTGACTTCCTCTGCTATGAGAGCAGAAACAAGAGCTGTTGGAAACACTTGGCCTCATCTGGGGGTTCTAGGCTAGGTCATACCTTAGGATATAGAGAGAACCAGGTTCCAGCAACAGTTCCAGCCACTGCTCAGGTTCCTGTGTATGAACCAGCTTCATAACACTTGG</td>
</tr>
<tr class="odd">
<td style="text-align: left;">BOR1061</td>
<td style="text-align: left;">apeh17</td>
<td style="text-align: left;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1373.5</td>
<td style="text-align: right;">415</td>
<td style="text-align: left;">394a483d3ae2ce5605f1674b2400986c</td>
<td style="text-align: left;">AAAGCCAGTGGAGCCACGATAGTTCACTGCAAGTGAGACAAGATAGTCGGGCAATGTTCTCAGTCCCCAACCCAATTCCATGTGTCTGTGACATAGGCCCTAGGACCAGCTGCATCACGTGCTGTCAAGGGGAGGTAGCCAAGAGAGATGAAGCTGCTACCCTGAGACCACAGCATCCTTTCCACAGAAGCTTCAAGTTAATCCACGTGATCACCAGGTTATGAAGCCAGAGGCTAAGCCAGGGCAATTTCTAGTAGTAGTTTCTTTTTGTTTTCAAAACAGGGTTTTTCTGTGCAGTCCTGGATGATCTTGGACTCAAACCTTCACCTGCCTCTGCCTCCTAAGTGCTGGATTAAAGGAGTGTGCCCCCATTGCCCAGCCCGTTTCTAAAGAGTAAGTACACCATAGAAAAGCA</td>
</tr>
<tr class="even">
<td style="text-align: left;">BOR1061</td>
<td style="text-align: left;">apeh17</td>
<td style="text-align: left;">1</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">1373.5</td>
<td style="text-align: right;">415</td>
<td style="text-align: left;">394a483d3ae2ce5605f1674b2400986c</td>
<td style="text-align: left;">AAAGCCAGTGGAGCCACGATAGTTCACTGCAAGTGAGACAAGATAGTCGGGCAATGTTCTCAGTCCCCAACCCAATTCCATGTGTCTGTGACATAGGCCCTAGGACCAGCTGCATCACGTGCTGTCAAGGGGAGGTAGCCAAGAGAGATGAAGCTGCTACCCTGAGACCACAGCATCCTTTCCACAGAAGCTTCAAGTTAATCCACGTGATCACCAGGTTATGAAGCCAGAGGCTAAGCCAGGGCAATTTCTAGTAGTAGTTTCTTTTTGTTTTCAAAACAGGGTTTTTCTGTGCAGTCCTGGATGATCTTGGACTCAAACCTTCACCTGCCTCTGCCTCCTAAGTGCTGGATTAAAGGAGTGTGCCCCCATTGCCCAGCCCGTTTCTAAAGAGTAAGTACACCATAGAAAAGCA</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="tidygenr-vs-amplisas" class="level2">
<h2 class="anchored" data-anchor-id="tidygenr-vs-amplisas"><em>tidyGenR</em> vs AmpliSAS</h2>
<p><a href="https://doi.org/10.1111/1755-0998.12453">AmpliSAS</a> is a software written in PERL with similar characteristics to <em>tidyGenR</em>. To compare their performance we run AmpliSAS in a docker container to genotype our raw sequences. The steps are detailed <a href="code/amplisas">here</a>. AmpliSAS returns results in a multisheet EXCEL and in plain text files, one per locus. The function <code>amplisas2tidy()</code> permits to read plain text results from AmpliSAS into tidy variants.</p>
<p>Create input for AmpliSAS:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># amplicon metadata</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"code/amplisas/01_create_amplicon_data.R"</span>)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="co"># append barcodes to reads</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"code/amplisas/02_add_barcodes.R"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>AmpliSAS is run in a DOCKER container. The steps are detailed <a href="amplisas/benchmarking.md">here</a>.</p>
</section>
<section id="integration-of-alleles-with-publised-data" class="level1">
<h1>Integration of alleles with publised data</h1>
<div class="cell">

</div>
</section>
<section id="session-info" class="level1">
<h1>session info</h1>
<p>Details on the sessionInfo() are <a href="session_info.txt">here</a>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">writeLines</span>(<span class="fu">capture.output</span>(<span class="fu">sessionInfo</span>()), <span class="at">con =</span> <span class="st">"session_info.txt"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- -->

</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb32" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> Miguel Camacho Sánchez</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "tidyGenR benchmarking"</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="an">editor:</span><span class="co"> visual</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="an">theme:</span><span class="co"> minty</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>Attach libraries:</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>opts_knit<span class="sc">$</span><span class="fu">set</span>(<span class="at">root.dir =</span> <span class="st">"../"</span>)</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a><span class="in">```{r attach packages}</span></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyGenR)</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval_conditionals}</span></span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a><span class="co"># declare logicals to trigger EVAL in intensive code chunks</span></span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a><span class="co"># they are not run if output already exists.</span></span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a><span class="co"># to run a fresh analysis outputs need to be removed.</span></span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a><span class="co"># demultiplex</span></span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a>c_log <span class="ot">&lt;-</span> <span class="st">"output/cutadapt.log"</span></span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>eval_demultiplex <span class="ot">&lt;-</span> <span class="sc">!</span><span class="fu">file.exists</span>(c_log)</span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a><span class="co"># truncate</span></span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a>tr_path <span class="ot">&lt;-</span> <span class="st">"output/trunc_in-out.rds"</span></span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a>eval_truncate <span class="ot">&lt;-</span> <span class="sc">!</span><span class="fu">file.exists</span>(tr_path)</span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a><span class="co"># explore_dada</span></span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a>x_out_path <span class="ot">&lt;-</span> <span class="st">"output/explore_dada.rds"</span></span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a>eval_x <span class="ot">&lt;-</span> <span class="sc">!</span><span class="fu">file.exists</span>(x_out_path)</span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a><span class="co"># variant_call</span></span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a>x_variants_path <span class="ot">&lt;-</span>  <span class="st">"output/variants_x.rds"</span></span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a>eval_variant_call <span class="ot">&lt;-</span> <span class="sc">!</span><span class="fu">file.exists</span>(x_variants_path)</span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a><span class="co"># genotype</span></span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a>x_genotypes_path <span class="ot">&lt;-</span>  <span class="st">"output/genotypes_x.rds"</span></span>
<span id="cb32-50"><a href="#cb32-50" aria-hidden="true" tabindex="-1"></a>eval_genotype <span class="ot">&lt;-</span> <span class="sc">!</span><span class="fu">file.exists</span>(x_genotypes_path)</span>
<span id="cb32-51"><a href="#cb32-51" aria-hidden="true" tabindex="-1"></a><span class="co"># amplisas</span></span>
<span id="cb32-52"><a href="#cb32-52" aria-hidden="true" tabindex="-1"></a>amplisas_results <span class="ot">&lt;-</span> <span class="st">""</span></span>
<span id="cb32-53"><a href="#cb32-53" aria-hidden="true" tabindex="-1"></a>eval_amplisas <span class="ot">&lt;-</span> <span class="sc">!</span><span class="fu">file.exists</span>(amplisas_results)</span>
<span id="cb32-54"><a href="#cb32-54" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-55"><a href="#cb32-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-56"><a href="#cb32-56" aria-hidden="true" tabindex="-1"></a><span class="fu">## Benchmarking *tidyGenR*</span></span>
<span id="cb32-57"><a href="#cb32-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-58"><a href="#cb32-58" aria-hidden="true" tabindex="-1"></a>This repository accompanies the R package **tidyGenR** available at <span class="ot">&lt;https://github.com/csmiguel/tidyGenR&gt;</span>. It covers (1) all steps for genotype calling with *tidyGenR*, (2) exploration of the parameters for variant calling, and (3) comparison of *tidyGenR* against [AmpliSAS](https://doi.org/10.1111/1755-0998.12453). It uses real data from a population genetics study of the wild rodent *Rattus baluensis* (Camacho-Sanchez et al. *in preparation*).</span>
<span id="cb32-59"><a href="#cb32-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-60"><a href="#cb32-60" aria-hidden="true" tabindex="-1"></a><span class="fu">## Preparation of input data</span></span>
<span id="cb32-61"><a href="#cb32-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-62"><a href="#cb32-62" aria-hidden="true" tabindex="-1"></a>Raw sequences are deposited in NCBI under the BioStudy <span class="co">[</span><span class="ot">SRP293699</span><span class="co">](https://trace.ncbi.nlm.nih.gov/Traces/study/?acc=SRP293699)</span>, in the BioProject <span class="co">[</span><span class="ot">PRJNA680166</span><span class="co">](https://www.ncbi.nlm.nih.gov/bioproject/PRJNA680166)</span>. From the BioStudy, we can download the <span class="co">[</span><span class="ot">SRA metadata</span><span class="co">](data/raw/SraRunTable.csv)</span> to map sample IDs to SRRs:</span>
<span id="cb32-63"><a href="#cb32-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-64"><a href="#cb32-64" aria-hidden="true" tabindex="-1"></a><span class="in">```{r SRR}</span></span>
<span id="cb32-65"><a href="#cb32-65" aria-hidden="true" tabindex="-1"></a><span class="co"># table with mapped SRR-sampleIDs</span></span>
<span id="cb32-66"><a href="#cb32-66" aria-hidden="true" tabindex="-1"></a>srr <span class="ot">&lt;-</span></span>
<span id="cb32-67"><a href="#cb32-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read.csv</span>(<span class="st">"data/raw/SraRunTable.csv"</span>) <span class="sc">|&gt;</span></span>
<span id="cb32-68"><a href="#cb32-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Run, <span class="st">"Sample.Name"</span>) <span class="sc">|&gt;</span></span>
<span id="cb32-69"><a href="#cb32-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">run =</span> Run,</span>
<span id="cb32-70"><a href="#cb32-70" aria-hidden="true" tabindex="-1"></a>         <span class="at">sample =</span> <span class="st">"Sample.Name"</span>)</span>
<span id="cb32-71"><a href="#cb32-71" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="fu">head</span>(srr, <span class="dv">3</span>))</span>
<span id="cb32-72"><a href="#cb32-72" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-73"><a href="#cb32-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-74"><a href="#cb32-74" aria-hidden="true" tabindex="-1"></a>The FASTQ reads from the SRRs can be downloaded with <span class="co">[</span><span class="ot">SRA-toolkit</span><span class="co">](https://github.com/ncbi/sra-tools)</span>:</span>
<span id="cb32-75"><a href="#cb32-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-76"><a href="#cb32-76" aria-hidden="true" tabindex="-1"></a><span class="in">```{r download_raw_data}</span></span>
<span id="cb32-77"><a href="#cb32-77" aria-hidden="true" tabindex="-1"></a><span class="co">#|  message: false</span></span>
<span id="cb32-78"><a href="#cb32-78" aria-hidden="true" tabindex="-1"></a><span class="co">#|  warning: false</span></span>
<span id="cb32-79"><a href="#cb32-79" aria-hidden="true" tabindex="-1"></a><span class="co">#|  error: false</span></span>
<span id="cb32-80"><a href="#cb32-80" aria-hidden="true" tabindex="-1"></a><span class="co">#|  code-fold: true</span></span>
<span id="cb32-81"><a href="#cb32-81" aria-hidden="true" tabindex="-1"></a><span class="co"># download raw reads from NCBI</span></span>
<span id="cb32-82"><a href="#cb32-82" aria-hidden="true" tabindex="-1"></a><span class="co"># they are not downloaded if already present in 'data/raw'.</span></span>
<span id="cb32-83"><a href="#cb32-83" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(srr, <span class="dv">1</span>, <span class="cf">function</span>(x) {</span>
<span id="cb32-84"><a href="#cb32-84" aria-hidden="true" tabindex="-1"></a>  <span class="co"># name paths</span></span>
<span id="cb32-85"><a href="#cb32-85" aria-hidden="true" tabindex="-1"></a>  srr_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">"data/raw"</span>, x[<span class="dv">1</span>])</span>
<span id="cb32-86"><a href="#cb32-86" aria-hidden="true" tabindex="-1"></a>  srr1 <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">"data/raw"</span>, <span class="fu">paste0</span>(x[<span class="dv">1</span>], <span class="st">"_1.fastq"</span>))</span>
<span id="cb32-87"><a href="#cb32-87" aria-hidden="true" tabindex="-1"></a>  srr2 <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">"data/raw"</span>, <span class="fu">paste0</span>(x[<span class="dv">1</span>], <span class="st">"_2.fastq"</span>))</span>
<span id="cb32-88"><a href="#cb32-88" aria-hidden="true" tabindex="-1"></a>  sam1 <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">"data/raw"</span>, <span class="fu">paste0</span>(x[<span class="dv">2</span>], <span class="st">"_1.fastq"</span>))</span>
<span id="cb32-89"><a href="#cb32-89" aria-hidden="true" tabindex="-1"></a>  sam2 <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">"data/raw"</span>, <span class="fu">paste0</span>(x[<span class="dv">2</span>], <span class="st">"_2.fastq"</span>))</span>
<span id="cb32-90"><a href="#cb32-90" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fetch SRR</span></span>
<span id="cb32-91"><a href="#cb32-91" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">any</span>(<span class="fu">dir.exists</span>(srr_path) <span class="sc">||</span> <span class="fu">file.exists</span>(sam1))) {</span>
<span id="cb32-92"><a href="#cb32-92" aria-hidden="true" tabindex="-1"></a>    <span class="fu">system2</span>(<span class="st">"prefetch"</span>, <span class="fu">paste</span>(<span class="st">"-O"</span>, <span class="st">"data/raw/"</span>, x[<span class="dv">1</span>]))</span>
<span id="cb32-93"><a href="#cb32-93" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-94"><a href="#cb32-94" aria-hidden="true" tabindex="-1"></a>  <span class="co"># reformat to FASTQ</span></span>
<span id="cb32-95"><a href="#cb32-95" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(sam1)) {</span>
<span id="cb32-96"><a href="#cb32-96" aria-hidden="true" tabindex="-1"></a>    <span class="fu">system2</span>(<span class="st">"fasterq-dump"</span>, <span class="fu">paste</span>(<span class="st">"-O"</span>, <span class="st">"data/raw/"</span>, srr_path))</span>
<span id="cb32-97"><a href="#cb32-97" aria-hidden="true" tabindex="-1"></a>    <span class="fu">system2</span>(<span class="st">"mv"</span>, <span class="fu">paste</span>(srr1, sam1))</span>
<span id="cb32-98"><a href="#cb32-98" aria-hidden="true" tabindex="-1"></a>    <span class="fu">system2</span>(<span class="st">"mv"</span>, <span class="fu">paste</span>(srr2, sam2))</span>
<span id="cb32-99"><a href="#cb32-99" aria-hidden="true" tabindex="-1"></a>    <span class="co"># rm SRR</span></span>
<span id="cb32-100"><a href="#cb32-100" aria-hidden="true" tabindex="-1"></a>    <span class="fu">system2</span>(<span class="st">"rm"</span>, <span class="fu">paste0</span>(<span class="st">"-r "</span>, srr_path, <span class="st">"*"</span>))</span>
<span id="cb32-101"><a href="#cb32-101" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-102"><a href="#cb32-102" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb32-103"><a href="#cb32-103" aria-hidden="true" tabindex="-1"></a><span class="co"># glimpse raw FASTQ</span></span>
<span id="cb32-104"><a href="#cb32-104" aria-hidden="true" tabindex="-1"></a><span class="fu">list.files</span>(<span class="st">"data/raw"</span>, <span class="at">pattern =</span> <span class="st">"fastq"</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>]</span>
<span id="cb32-105"><a href="#cb32-105" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-106"><a href="#cb32-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-107"><a href="#cb32-107" aria-hidden="true" tabindex="-1"></a>Check input data files:</span>
<span id="cb32-108"><a href="#cb32-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-109"><a href="#cb32-109" aria-hidden="true" tabindex="-1"></a><span class="in">```{r check_raw_reads}</span></span>
<span id="cb32-110"><a href="#cb32-110" aria-hidden="true" tabindex="-1"></a>freads <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">"data/raw"</span>, <span class="at">pattern =</span> <span class="st">"1.fastq"</span>,</span>
<span id="cb32-111"><a href="#cb32-111" aria-hidden="true" tabindex="-1"></a>                    <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb32-112"><a href="#cb32-112" aria-hidden="true" tabindex="-1"></a>rreads <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">"data/raw"</span>, <span class="at">pattern =</span> <span class="st">"2.fastq"</span>,</span>
<span id="cb32-113"><a href="#cb32-113" aria-hidden="true" tabindex="-1"></a>                    <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb32-114"><a href="#cb32-114" aria-hidden="true" tabindex="-1"></a>chr <span class="ot">&lt;-</span> <span class="fu">check_raw_reads</span>(freads, rreads, <span class="at">low_readcount =</span> <span class="dv">10</span>)</span>
<span id="cb32-115"><a href="#cb32-115" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-116"><a href="#cb32-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-117"><a href="#cb32-117" aria-hidden="true" tabindex="-1"></a>Input FASTQ is conditions for *tidyGenR*. A total of <span class="in">`r length(chr$samples)`</span> are detected:</span>
<span id="cb32-118"><a href="#cb32-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-121"><a href="#cb32-121" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-122"><a href="#cb32-122" aria-hidden="true" tabindex="-1"></a>chr<span class="sc">$</span>samples</span>
<span id="cb32-123"><a href="#cb32-123" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-124"><a href="#cb32-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-125"><a href="#cb32-125" aria-hidden="true" tabindex="-1"></a><span class="fu">## Demultiplex by locus</span></span>
<span id="cb32-126"><a href="#cb32-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-127"><a href="#cb32-127" aria-hidden="true" tabindex="-1"></a>Reads are demultiplexed by locus using primer sequences in paired-end mode.</span>
<span id="cb32-128"><a href="#cb32-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-129"><a href="#cb32-129" aria-hidden="true" tabindex="-1"></a><span class="in">```{r demultiplex_objects}</span></span>
<span id="cb32-130"><a href="#cb32-130" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb32-131"><a href="#cb32-131" aria-hidden="true" tabindex="-1"></a><span class="co"># load primer data</span></span>
<span id="cb32-132"><a href="#cb32-132" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"primers"</span>)</span>
<span id="cb32-133"><a href="#cb32-133" aria-hidden="true" tabindex="-1"></a><span class="co"># path to cutadapt</span></span>
<span id="cb32-134"><a href="#cb32-134" aria-hidden="true" tabindex="-1"></a>cutadapt <span class="ot">&lt;-</span> <span class="fu">system</span>(<span class="st">"which cutadapt"</span>, <span class="at">intern =</span> <span class="cn">TRUE</span>)</span>
<span id="cb32-135"><a href="#cb32-135" aria-hidden="true" tabindex="-1"></a><span class="co"># path to folder save locus-demultiplexed FASTQ</span></span>
<span id="cb32-136"><a href="#cb32-136" aria-hidden="true" tabindex="-1"></a>demult <span class="ot">&lt;-</span> <span class="st">"data/intermediate/demultiplexed"</span></span>
<span id="cb32-137"><a href="#cb32-137" aria-hidden="true" tabindex="-1"></a><span class="co"># print primers</span></span>
<span id="cb32-138"><a href="#cb32-138" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="fu">head</span>(primers, <span class="dv">3</span>))</span>
<span id="cb32-139"><a href="#cb32-139" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-140"><a href="#cb32-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-141"><a href="#cb32-141" aria-hidden="true" tabindex="-1"></a><span class="in">```{r demultiplex}</span></span>
<span id="cb32-142"><a href="#cb32-142" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: !expr eval_demultiplex</span></span>
<span id="cb32-143"><a href="#cb32-143" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb32-144"><a href="#cb32-144" aria-hidden="true" tabindex="-1"></a><span class="co"># demultiplex</span></span>
<span id="cb32-145"><a href="#cb32-145" aria-hidden="true" tabindex="-1"></a><span class="fu">demultiplex</span>(</span>
<span id="cb32-146"><a href="#cb32-146" aria-hidden="true" tabindex="-1"></a>  <span class="at">interpreter =</span> <span class="st">"/bin/bash"</span>,</span>
<span id="cb32-147"><a href="#cb32-147" aria-hidden="true" tabindex="-1"></a>  <span class="at">cutadapt =</span> cutadapt,</span>
<span id="cb32-148"><a href="#cb32-148" aria-hidden="true" tabindex="-1"></a>  <span class="at">freads =</span> freads,</span>
<span id="cb32-149"><a href="#cb32-149" aria-hidden="true" tabindex="-1"></a>  <span class="at">rreads =</span> rreads,</span>
<span id="cb32-150"><a href="#cb32-150" aria-hidden="true" tabindex="-1"></a>  <span class="at">primers =</span> primers,</span>
<span id="cb32-151"><a href="#cb32-151" aria-hidden="true" tabindex="-1"></a>  <span class="at">sh_out =</span> <span class="st">"code/demultiplex.sh"</span>,</span>
<span id="cb32-152"><a href="#cb32-152" aria-hidden="true" tabindex="-1"></a>  <span class="at">write_demultiplexed =</span> demult,</span>
<span id="cb32-153"><a href="#cb32-153" aria-hidden="true" tabindex="-1"></a>  <span class="at">log_out =</span> c_log,</span>
<span id="cb32-154"><a href="#cb32-154" aria-hidden="true" tabindex="-1"></a>  <span class="at">mode =</span> <span class="st">"pe"</span>,</span>
<span id="cb32-155"><a href="#cb32-155" aria-hidden="true" tabindex="-1"></a>  <span class="at">run =</span> <span class="cn">TRUE</span>)</span>
<span id="cb32-156"><a href="#cb32-156" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-157"><a href="#cb32-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-160"><a href="#cb32-160" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-161"><a href="#cb32-161" aria-hidden="true" tabindex="-1"></a><span class="co"># glimpse demultiplexed FASTQ</span></span>
<span id="cb32-162"><a href="#cb32-162" aria-hidden="true" tabindex="-1"></a><span class="fu">list.files</span>(demult, <span class="at">pattern =</span> <span class="st">"fastq"</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>]</span>
<span id="cb32-163"><a href="#cb32-163" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-164"><a href="#cb32-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-165"><a href="#cb32-165" aria-hidden="true" tabindex="-1"></a>Remove files with few reads:</span>
<span id="cb32-166"><a href="#cb32-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-167"><a href="#cb32-167" aria-hidden="true" tabindex="-1"></a><span class="in">```{r rm_after_dem}</span></span>
<span id="cb32-168"><a href="#cb32-168" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb32-169"><a href="#cb32-169" aria-hidden="true" tabindex="-1"></a><span class="fu">remove_poor_fastq</span>(demult,</span>
<span id="cb32-170"><a href="#cb32-170" aria-hidden="true" tabindex="-1"></a>                   <span class="at">min_reads =</span> <span class="dv">10</span>)</span>
<span id="cb32-171"><a href="#cb32-171" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-172"><a href="#cb32-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-173"><a href="#cb32-173" aria-hidden="true" tabindex="-1"></a><span class="fu">## Truncate reads</span></span>
<span id="cb32-174"><a href="#cb32-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-175"><a href="#cb32-175" aria-hidden="true" tabindex="-1"></a>Reads are truncated to a given length for each locus. A <span class="in">`data.frame`</span> with truncation lengths for forward and reverse reads was built to maximize the amount of information yielded by each locus. For instance, the amplicons for some loci, as *nfkbia*, are long and it is a good trade-off to leave the low quality ends in but to be sure both F and R reads overlap.</span>
<span id="cb32-176"><a href="#cb32-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-177"><a href="#cb32-177" aria-hidden="true" tabindex="-1"></a>Building of <span class="in">`data.frame`</span> with locus-specific truncation lengths:</span>
<span id="cb32-178"><a href="#cb32-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-179"><a href="#cb32-179" aria-hidden="true" tabindex="-1"></a><span class="in">```{r build_trunc_fr}</span></span>
<span id="cb32-180"><a href="#cb32-180" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb32-181"><a href="#cb32-181" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb32-182"><a href="#cb32-182" aria-hidden="true" tabindex="-1"></a>loci <span class="ot">&lt;-</span> </span>
<span id="cb32-183"><a href="#cb32-183" aria-hidden="true" tabindex="-1"></a>  tidyGenR<span class="sc">:::</span><span class="fu">check_names_demultiplexed</span>(demult,</span>
<span id="cb32-184"><a href="#cb32-184" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">fw_pattern =</span> <span class="st">"1.fastq.gz"</span>,</span>
<span id="cb32-185"><a href="#cb32-185" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">rv_pattern =</span> <span class="st">"2.fastq.gz"</span>)<span class="sc">$</span>loci</span>
<span id="cb32-186"><a href="#cb32-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-187"><a href="#cb32-187" aria-hidden="true" tabindex="-1"></a>trunc_fr <span class="ot">&lt;-</span></span>
<span id="cb32-188"><a href="#cb32-188" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">locus =</span> loci,</span>
<span id="cb32-189"><a href="#cb32-189" aria-hidden="true" tabindex="-1"></a>             <span class="at">trunc_f =</span> <span class="dv">270</span>,</span>
<span id="cb32-190"><a href="#cb32-190" aria-hidden="true" tabindex="-1"></a>             <span class="at">trunc_r =</span> <span class="dv">180</span>)</span>
<span id="cb32-191"><a href="#cb32-191" aria-hidden="true" tabindex="-1"></a><span class="co"># introduce manual values</span></span>
<span id="cb32-192"><a href="#cb32-192" aria-hidden="true" tabindex="-1"></a>trunc_fr[<span class="fu">which</span>(loci <span class="sc">==</span> <span class="st">"rgd735029"</span>), <span class="st">"trunc_f"</span>] <span class="ot">&lt;-</span>  <span class="dv">245</span></span>
<span id="cb32-193"><a href="#cb32-193" aria-hidden="true" tabindex="-1"></a>trunc_fr[<span class="fu">which</span>(loci <span class="sc">==</span> <span class="st">"rgd735029"</span>), <span class="st">"trunc_r"</span>] <span class="ot">&lt;-</span>  <span class="dv">155</span></span>
<span id="cb32-194"><a href="#cb32-194" aria-hidden="true" tabindex="-1"></a>trunc_fr[<span class="fu">which</span>(loci <span class="sc">==</span> <span class="st">"fancg"</span>), <span class="st">"trunc_r"</span>] <span class="ot">&lt;-</span> <span class="dv">190</span></span>
<span id="cb32-195"><a href="#cb32-195" aria-hidden="true" tabindex="-1"></a>trunc_fr[<span class="fu">which</span>(loci <span class="sc">==</span> <span class="st">"nfkbia"</span>), <span class="st">"trunc_r"</span>] <span class="ot">&lt;-</span> <span class="dv">240</span></span>
<span id="cb32-196"><a href="#cb32-196" aria-hidden="true" tabindex="-1"></a>trunc_fr[<span class="fu">which</span>(loci <span class="sc">==</span> <span class="st">"tmem87a"</span>), <span class="st">"trunc_r"</span>] <span class="ot">&lt;-</span> <span class="dv">160</span></span>
<span id="cb32-197"><a href="#cb32-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-198"><a href="#cb32-198" aria-hidden="true" tabindex="-1"></a><span class="co"># glimpse data.frame with locus-specific truncation lengths</span></span>
<span id="cb32-199"><a href="#cb32-199" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="fu">head</span>(trunc_fr, <span class="dv">3</span>))</span>
<span id="cb32-200"><a href="#cb32-200" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-201"><a href="#cb32-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-202"><a href="#cb32-202" aria-hidden="true" tabindex="-1"></a>Truncate reads according to locus-specific truncation lengths:</span>
<span id="cb32-203"><a href="#cb32-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-204"><a href="#cb32-204" aria-hidden="true" tabindex="-1"></a><span class="in">```{r declare_tr_dir}</span></span>
<span id="cb32-205"><a href="#cb32-205" aria-hidden="true" tabindex="-1"></a>tr_dir <span class="ot">&lt;-</span> <span class="st">"data/intermediate/truncated"</span></span>
<span id="cb32-206"><a href="#cb32-206" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-207"><a href="#cb32-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-208"><a href="#cb32-208" aria-hidden="true" tabindex="-1"></a><span class="in">```{r truncate}</span></span>
<span id="cb32-209"><a href="#cb32-209" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb32-210"><a href="#cb32-210" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb32-211"><a href="#cb32-211" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: !expr eval_truncate</span></span>
<span id="cb32-212"><a href="#cb32-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-213"><a href="#cb32-213" aria-hidden="true" tabindex="-1"></a><span class="co"># truncate</span></span>
<span id="cb32-214"><a href="#cb32-214" aria-hidden="true" tabindex="-1"></a>trunc_out <span class="ot">&lt;-</span></span>
<span id="cb32-215"><a href="#cb32-215" aria-hidden="true" tabindex="-1"></a>  <span class="fu">trunc_amp</span>(<span class="at">in_dir =</span> demult,</span>
<span id="cb32-216"><a href="#cb32-216" aria-hidden="true" tabindex="-1"></a>          <span class="at">fw_pattern =</span> <span class="st">"1.fastq.gz"</span>,</span>
<span id="cb32-217"><a href="#cb32-217" aria-hidden="true" tabindex="-1"></a>          <span class="at">rv_pattern =</span> <span class="st">"2.fastq.gz"</span>,</span>
<span id="cb32-218"><a href="#cb32-218" aria-hidden="true" tabindex="-1"></a>          <span class="at">trunc_fr =</span> trunc_fr,</span>
<span id="cb32-219"><a href="#cb32-219" aria-hidden="true" tabindex="-1"></a>          <span class="at">write_trun =</span> tr_dir,</span>
<span id="cb32-220"><a href="#cb32-220" aria-hidden="true" tabindex="-1"></a>          <span class="at">max_ee =</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">5</span>),</span>
<span id="cb32-221"><a href="#cb32-221" aria-hidden="true" tabindex="-1"></a>          <span class="at">trunc_q =</span> <span class="dv">2</span>)</span>
<span id="cb32-222"><a href="#cb32-222" aria-hidden="true" tabindex="-1"></a><span class="co"># save reads in and out</span></span>
<span id="cb32-223"><a href="#cb32-223" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(trunc_out, tr_path)</span>
<span id="cb32-224"><a href="#cb32-224" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-225"><a href="#cb32-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-226"><a href="#cb32-226" aria-hidden="true" tabindex="-1"></a>The output from <span class="in">`trunc_amp()`</span> is a list of matrices with IN and OUT reads after truncation:</span>
<span id="cb32-227"><a href="#cb32-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-230"><a href="#cb32-230" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-231"><a href="#cb32-231" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb32-232"><a href="#cb32-232" aria-hidden="true" tabindex="-1"></a>trunc_out <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(tr_path)</span>
<span id="cb32-233"><a href="#cb32-233" aria-hidden="true" tabindex="-1"></a><span class="fu">remove_poor_fastq</span>(tr_path,</span>
<span id="cb32-234"><a href="#cb32-234" aria-hidden="true" tabindex="-1"></a>                   <span class="at">min_reads =</span> <span class="dv">10</span>)</span>
<span id="cb32-235"><a href="#cb32-235" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-236"><a href="#cb32-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-239"><a href="#cb32-239" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-240"><a href="#cb32-240" aria-hidden="true" tabindex="-1"></a><span class="co"># see trunc_out</span></span>
<span id="cb32-241"><a href="#cb32-241" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(trunc_out[<span class="fu">seq_len</span>(<span class="dv">3</span>)], head, <span class="dv">3</span>)</span>
<span id="cb32-242"><a href="#cb32-242" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-243"><a href="#cb32-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-244"><a href="#cb32-244" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exploration of the parameter space</span></span>
<span id="cb32-245"><a href="#cb32-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-246"><a href="#cb32-246" aria-hidden="true" tabindex="-1"></a>The function <span class="in">`explore_dada()`</span> can be used to explore the effect of DADA2 parameters ("OMEGA_A", "BAND_SIZE", "pool") on the sensitivity on the variant calling.</span>
<span id="cb32-247"><a href="#cb32-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-248"><a href="#cb32-248" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>*omega_a*: threshold for variants to be significant overabundant *log(-log(birth_pval))* (see <span class="co">[</span><span class="ot">Rosen et al. 2012</span><span class="co">](https://doi.org/10.1186/1471-2105-13-283.)</span>).</span>
<span id="cb32-249"><a href="#cb32-249" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>*band_size*: positive numbers set a band size in Needleman-Wunsch alignments. In this context, ends free alignment is performed. A value of zero turns off banding, triggering full Needleman-Wunsch alignments, in which gapless alignment is performed (see <span class="co">[</span><span class="ot">issue</span><span class="co">](https://github.com/benjjneb/dada2/issues/1982)</span>).</span>
<span id="cb32-250"><a href="#cb32-250" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>*pool*: calling variants pooling samples can increase sensitivity (see <span class="co">[</span><span class="ot">dicussion</span><span class="co">](https://benjjneb.github.io/dada2/pseudo.html)</span>).</span>
<span id="cb32-251"><a href="#cb32-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-252"><a href="#cb32-252" aria-hidden="true" tabindex="-1"></a>The returned plots can be used to guide the election of the best *OMEGA_A* in `variant_call()`, or frequency (*maf*) and abundance thresholds (*ad*) for filtering variants.</span>
<span id="cb32-253"><a href="#cb32-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-254"><a href="#cb32-254" aria-hidden="true" tabindex="-1"></a>Explore variants:</span>
<span id="cb32-255"><a href="#cb32-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-258"><a href="#cb32-258" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-259"><a href="#cb32-259" aria-hidden="true" tabindex="-1"></a><span class="co"># declare candidate OMEGA_A to use in variant_call()</span></span>
<span id="cb32-260"><a href="#cb32-260" aria-hidden="true" tabindex="-1"></a>candidate_omega_a <span class="ot">&lt;-</span> <span class="dv">10</span><span class="sc">^-</span><span class="dv">2</span></span>
<span id="cb32-261"><a href="#cb32-261" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-262"><a href="#cb32-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-263"><a href="#cb32-263" aria-hidden="true" tabindex="-1"></a><span class="in">```{r explore_dada}</span></span>
<span id="cb32-264"><a href="#cb32-264" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: !expr eval_x</span></span>
<span id="cb32-265"><a href="#cb32-265" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb32-266"><a href="#cb32-266" aria-hidden="true" tabindex="-1"></a><span class="co"># paths to forward and reverse truncated reads</span></span>
<span id="cb32-267"><a href="#cb32-267" aria-hidden="true" tabindex="-1"></a>ftrun <span class="ot">&lt;-</span></span>
<span id="cb32-268"><a href="#cb32-268" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list.files</span>(tr_dir, <span class="at">pattern =</span> <span class="st">"_F_"</span>, <span class="at">full.names =</span> T)</span>
<span id="cb32-269"><a href="#cb32-269" aria-hidden="true" tabindex="-1"></a>rtrun <span class="ot">&lt;-</span></span>
<span id="cb32-270"><a href="#cb32-270" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list.files</span>(tr_dir, <span class="at">pattern =</span> <span class="st">"_R_"</span>, <span class="at">full.names =</span> T)</span>
<span id="cb32-271"><a href="#cb32-271" aria-hidden="true" tabindex="-1"></a><span class="co"># candidate omegavalue to annotate vline in plots.</span></span>
<span id="cb32-272"><a href="#cb32-272" aria-hidden="true" tabindex="-1"></a>v_line <span class="ot">&lt;-</span> <span class="fu">log</span>(<span class="sc">-</span><span class="fu">log</span>(candidate_omega_a))</span>
<span id="cb32-273"><a href="#cb32-273" aria-hidden="true" tabindex="-1"></a><span class="co"># run explore_dada() with band_size = 0, non pooling and omega_a = 0.9</span></span>
<span id="cb32-274"><a href="#cb32-274" aria-hidden="true" tabindex="-1"></a><span class="co"># forward</span></span>
<span id="cb32-275"><a href="#cb32-275" aria-hidden="true" tabindex="-1"></a>F_ind_0 <span class="ot">&lt;-</span></span>
<span id="cb32-276"><a href="#cb32-276" aria-hidden="true" tabindex="-1"></a>  <span class="fu">explore_dada</span>(ftrun, <span class="at">band_size =</span> <span class="dv">0</span>, <span class="at">vline =</span> v_line, <span class="at">hline_fr =</span> <span class="fl">0.1</span>)</span>
<span id="cb32-277"><a href="#cb32-277" aria-hidden="true" tabindex="-1"></a><span class="co"># reverse</span></span>
<span id="cb32-278"><a href="#cb32-278" aria-hidden="true" tabindex="-1"></a>R_ind_0 <span class="ot">&lt;-</span></span>
<span id="cb32-279"><a href="#cb32-279" aria-hidden="true" tabindex="-1"></a>  <span class="fu">explore_dada</span>(rtrun, <span class="at">band_size =</span> <span class="dv">0</span>, <span class="at">vline =</span> v_line, <span class="at">hline_fr =</span> <span class="fl">0.1</span>)</span>
<span id="cb32-280"><a href="#cb32-280" aria-hidden="true" tabindex="-1"></a><span class="co"># save results</span></span>
<span id="cb32-281"><a href="#cb32-281" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(<span class="fu">list</span>(<span class="at">F_ind_0 =</span> F_ind_0, <span class="at">R_ind_0 =</span> R_ind_0), x_out_path)</span>
<span id="cb32-282"><a href="#cb32-282" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-283"><a href="#cb32-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-284"><a href="#cb32-284" aria-hidden="true" tabindex="-1"></a>Exploration of DADA2 clustering for forward (A, C) and reverse (B, D) reads. The Y-axis represents the frequency of the variant in each locus and sample. The *log(-log(birth_pval))* transformation in the X-axis is related to the p-value of a variant being significantly overabundant. Larger x-values represent likely true variants. For representation purposes *birth_pval* of 0 (thus negative infinite), are converted to 10. Points are color-coded according to the variant rank in read abundance for its given locus and sample. For diploid individuals, <span class="co">[</span><span class="ot">green</span><span class="co">]</span>{style="color: green;"} are likely true variants and <span class="co">[</span><span class="ot">red</span><span class="co">]</span>{style="color: red;"} are likely false variants. <span class="co">[</span><span class="ot">Grey</span><span class="co">]</span>{style="color: grey;"} dashed lines are thresholds used for <span class="in">`variant_call()`</span>:</span>
<span id="cb32-285"><a href="#cb32-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-286"><a href="#cb32-286" aria-hidden="true" tabindex="-1"></a><span class="in">```{r x_attach_if_not_run}</span></span>
<span id="cb32-287"><a href="#cb32-287" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb32-288"><a href="#cb32-288" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb32-289"><a href="#cb32-289" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span>(<span class="fu">exists</span>(<span class="st">"F_ind_0"</span>) <span class="sc">||</span> <span class="fu">exists</span>(<span class="st">"R_ind_0"</span>))) {</span>
<span id="cb32-290"><a href="#cb32-290" aria-hidden="true" tabindex="-1"></a>    x_dada <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(x_out_path)</span>
<span id="cb32-291"><a href="#cb32-291" aria-hidden="true" tabindex="-1"></a>    <span class="fu">attach</span>(x_dada)</span>
<span id="cb32-292"><a href="#cb32-292" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-293"><a href="#cb32-293" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-294"><a href="#cb32-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-295"><a href="#cb32-295" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot_explore_dada}</span></span>
<span id="cb32-296"><a href="#cb32-296" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-explore_dada</span></span>
<span id="cb32-297"><a href="#cb32-297" aria-hidden="true" tabindex="-1"></a><span class="co">#| warnings: false</span></span>
<span id="cb32-298"><a href="#cb32-298" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Exploration of DADA2 variants"</span></span>
<span id="cb32-299"><a href="#cb32-299" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb32-300"><a href="#cb32-300" aria-hidden="true" tabindex="-1"></a>ppool <span class="ot">&lt;-</span></span>
<span id="cb32-301"><a href="#cb32-301" aria-hidden="true" tabindex="-1"></a>  (F_ind_0<span class="sc">$</span>p1 <span class="sc">|</span> R_ind_0<span class="sc">$</span>p1) <span class="sc">/</span> (F_ind_0<span class="sc">$</span>p2 <span class="sc">|</span> R_ind_0<span class="sc">$</span>p2) <span class="sc">+</span></span>
<span id="cb32-302"><a href="#cb32-302" aria-hidden="true" tabindex="-1"></a>  patchwork<span class="sc">::</span><span class="fu">plot_annotation</span>(<span class="at">title =</span> <span class="st">"Dada F/R pool = F, omega_a 0.9, band_size = 0"</span>,</span>
<span id="cb32-303"><a href="#cb32-303" aria-hidden="true" tabindex="-1"></a>                             <span class="at">tag_levels =</span> <span class="st">"A"</span>)</span>
<span id="cb32-304"><a href="#cb32-304" aria-hidden="true" tabindex="-1"></a><span class="co"># save plot with combined loci</span></span>
<span id="cb32-305"><a href="#cb32-305" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">"output/explore_dada.pdf"</span>, ppool, <span class="at">width =</span> <span class="dv">8</span>, <span class="at">height =</span> <span class="dv">5</span>)</span>
<span id="cb32-306"><a href="#cb32-306" aria-hidden="true" tabindex="-1"></a><span class="co"># print plot</span></span>
<span id="cb32-307"><a href="#cb32-307" aria-hidden="true" tabindex="-1"></a>ppool</span>
<span id="cb32-308"><a href="#cb32-308" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-309"><a href="#cb32-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-310"><a href="#cb32-310" aria-hidden="true" tabindex="-1"></a>After the exploration variants in @fig-explore_dada, it seems an *OMEGA_A* = <span class="in">`r candidate_omega_a`</span>, implying a cutoff of <span class="in">`r log(-log(candidate_omega_a))`</span> in the X-axis and a frequency threshold (Y-axis) of 0.1, excludes most <span class="co">[</span><span class="ot">artifacts</span><span class="co">]</span>{style="color: red;"} while maximizing <span class="co">[</span><span class="ot">true positives</span><span class="co">]</span>{style="color: green;"}.</span>
<span id="cb32-311"><a href="#cb32-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-312"><a href="#cb32-312" aria-hidden="true" tabindex="-1"></a>The results can also be explored **per-locus**. For instance, @fig-explore_dada B can be expanded per locus as follows:</span>
<span id="cb32-313"><a href="#cb32-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-316"><a href="#cb32-316" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-317"><a href="#cb32-317" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb32-318"><a href="#cb32-318" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb32-319"><a href="#cb32-319" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb32-320"><a href="#cb32-320" aria-hidden="true" tabindex="-1"></a><span class="co"># list of plots per locus</span></span>
<span id="cb32-321"><a href="#cb32-321" aria-hidden="true" tabindex="-1"></a>lplots <span class="ot">&lt;-</span></span>
<span id="cb32-322"><a href="#cb32-322" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">loci_f_ind_0_logp =</span> F_ind_0<span class="sc">$</span>p3,</span>
<span id="cb32-323"><a href="#cb32-323" aria-hidden="true" tabindex="-1"></a>       <span class="at">loci_r_ind_0_logp =</span> R_ind_0<span class="sc">$</span>p3,</span>
<span id="cb32-324"><a href="#cb32-324" aria-hidden="true" tabindex="-1"></a>       <span class="at">loci_f_ind_0_abun =</span> F_ind_0<span class="sc">$</span>p4,</span>
<span id="cb32-325"><a href="#cb32-325" aria-hidden="true" tabindex="-1"></a>       <span class="at">loci_r_ind_0_abun =</span> R_ind_0<span class="sc">$</span>p4)</span>
<span id="cb32-326"><a href="#cb32-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-327"><a href="#cb32-327" aria-hidden="true" tabindex="-1"></a><span class="co"># save plots per locus</span></span>
<span id="cb32-328"><a href="#cb32-328" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(<span class="fu">seq_along</span>(lplots), <span class="cf">function</span>(x) {</span>
<span id="cb32-329"><a href="#cb32-329" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="fu">paste0</span>(<span class="st">"output/"</span>, <span class="fu">names</span>(lplots)[x], <span class="st">".pdf"</span>),</span>
<span id="cb32-330"><a href="#cb32-330" aria-hidden="true" tabindex="-1"></a>         lplots[[x]], <span class="at">width =</span> <span class="dv">6</span>, <span class="at">height =</span> <span class="dv">6</span>)</span>
<span id="cb32-331"><a href="#cb32-331" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb32-332"><a href="#cb32-332" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-333"><a href="#cb32-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-336"><a href="#cb32-336" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-337"><a href="#cb32-337" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-explore_dada_loci</span></span>
<span id="cb32-338"><a href="#cb32-338" aria-hidden="true" tabindex="-1"></a><span class="co">#| warnings: false</span></span>
<span id="cb32-339"><a href="#cb32-339" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Exploration of DADA2 variants per locus for R reads"</span></span>
<span id="cb32-340"><a href="#cb32-340" aria-hidden="true" tabindex="-1"></a>lplots<span class="sc">$</span>loci_r_ind_0_logp</span>
<span id="cb32-341"><a href="#cb32-341" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-342"><a href="#cb32-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-343"><a href="#cb32-343" aria-hidden="true" tabindex="-1"></a><span class="fu">## Variant and genotype calling</span></span>
<span id="cb32-344"><a href="#cb32-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-345"><a href="#cb32-345" aria-hidden="true" tabindex="-1"></a>Variant calling is run using *OMEGA_A* = <span class="in">`r candidate_omega_a`</span>, and under different parameters:</span>
<span id="cb32-346"><a href="#cb32-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-347"><a href="#cb32-347" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>*band_size*: 0, 16</span>
<span id="cb32-348"><a href="#cb32-348" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>*pool*: TRUE, FALSE</span>
<span id="cb32-349"><a href="#cb32-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-350"><a href="#cb32-350" aria-hidden="true" tabindex="-1"></a><span class="in">```{r variant_call}</span></span>
<span id="cb32-351"><a href="#cb32-351" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb32-352"><a href="#cb32-352" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: !expr eval_variant_call</span></span>
<span id="cb32-353"><a href="#cb32-353" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb32-354"><a href="#cb32-354" aria-hidden="true" tabindex="-1"></a><span class="co"># list of parameters to run variant_call() with 4 different set of values:</span></span>
<span id="cb32-355"><a href="#cb32-355" aria-hidden="true" tabindex="-1"></a>variant_call_params <span class="ot">&lt;-</span></span>
<span id="cb32-356"><a href="#cb32-356" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb32-357"><a href="#cb32-357" aria-hidden="true" tabindex="-1"></a>    <span class="at">ind_bs16 =</span> <span class="fu">c</span>(<span class="cn">FALSE</span>, <span class="dv">16</span>), <span class="co"># pool = F, default band size == 16</span></span>
<span id="cb32-358"><a href="#cb32-358" aria-hidden="true" tabindex="-1"></a>    <span class="at">ind_bs0 =</span> <span class="fu">c</span>(<span class="cn">FALSE</span>, <span class="dv">0</span>), <span class="co"># pool = F, default band size == 0</span></span>
<span id="cb32-359"><a href="#cb32-359" aria-hidden="true" tabindex="-1"></a>    <span class="at">pool_bs16 =</span> <span class="fu">c</span>(<span class="cn">TRUE</span>, <span class="dv">16</span>), <span class="co"># pool = T, default band size == 16</span></span>
<span id="cb32-360"><a href="#cb32-360" aria-hidden="true" tabindex="-1"></a>    <span class="at">pool_bs0 =</span> <span class="fu">c</span>(<span class="cn">TRUE</span>, <span class="dv">0</span>) <span class="co"># pool = T, default band size == 0</span></span>
<span id="cb32-361"><a href="#cb32-361" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-362"><a href="#cb32-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-363"><a href="#cb32-363" aria-hidden="true" tabindex="-1"></a>variants_x <span class="ot">&lt;-</span></span>
<span id="cb32-364"><a href="#cb32-364" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(variant_call_params, <span class="cf">function</span>(x) {</span>
<span id="cb32-365"><a href="#cb32-365" aria-hidden="true" tabindex="-1"></a>    <span class="fu">variant_call</span>(<span class="at">in_folder =</span> tr_dir,</span>
<span id="cb32-366"><a href="#cb32-366" aria-hidden="true" tabindex="-1"></a>                 <span class="at">rv_pattern =</span> <span class="st">"R_filt.fastq.gz"</span>,</span>
<span id="cb32-367"><a href="#cb32-367" aria-hidden="true" tabindex="-1"></a>                 <span class="at">c_unmerged =</span> <span class="cn">TRUE</span>,</span>
<span id="cb32-368"><a href="#cb32-368" aria-hidden="true" tabindex="-1"></a>                 <span class="at">multithread =</span> <span class="cn">TRUE</span>,</span>
<span id="cb32-369"><a href="#cb32-369" aria-hidden="true" tabindex="-1"></a>                 <span class="at">pool =</span> <span class="fu">as.logical</span>(x[<span class="dv">1</span>]),</span>
<span id="cb32-370"><a href="#cb32-370" aria-hidden="true" tabindex="-1"></a>                 <span class="at">omega_a_f =</span> candidate_omega_a,</span>
<span id="cb32-371"><a href="#cb32-371" aria-hidden="true" tabindex="-1"></a>                 <span class="at">omega_a_r =</span> candidate_omega_a,</span>
<span id="cb32-372"><a href="#cb32-372" aria-hidden="true" tabindex="-1"></a>                 <span class="at">band_size =</span> x[<span class="dv">2</span>],</span>
<span id="cb32-373"><a href="#cb32-373" aria-hidden="true" tabindex="-1"></a>                 <span class="at">ad =</span> <span class="dv">10</span>,</span>
<span id="cb32-374"><a href="#cb32-374" aria-hidden="true" tabindex="-1"></a>                 <span class="at">maf =</span> <span class="fl">0.1</span>)</span>
<span id="cb32-375"><a href="#cb32-375" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb32-376"><a href="#cb32-376" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(variants_x, <span class="st">"output/variants_x.rds"</span>)</span>
<span id="cb32-377"><a href="#cb32-377" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-378"><a href="#cb32-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-381"><a href="#cb32-381" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-382"><a href="#cb32-382" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb32-383"><a href="#cb32-383" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"variants_x"</span>))</span>
<span id="cb32-384"><a href="#cb32-384" aria-hidden="true" tabindex="-1"></a>  variants_x <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"output/variants_x.rds"</span>)</span>
<span id="cb32-385"><a href="#cb32-385" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-386"><a href="#cb32-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-387"><a href="#cb32-387" aria-hidden="true" tabindex="-1"></a>Variants are used to genotype individuals with defaults <span class="in">`ploidy = 2`</span> and <span class="in">`ADt = 10`</span>:</span>
<span id="cb32-388"><a href="#cb32-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-391"><a href="#cb32-391" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-392"><a href="#cb32-392" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb32-393"><a href="#cb32-393" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: !expr eval_genotype</span></span>
<span id="cb32-394"><a href="#cb32-394" aria-hidden="true" tabindex="-1"></a>genotypes_x <span class="ot">&lt;-</span></span>
<span id="cb32-395"><a href="#cb32-395" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(variants_x, genotype)</span>
<span id="cb32-396"><a href="#cb32-396" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(genotypes_x, <span class="at">file =</span> <span class="st">"output/genotypes_x.rds"</span>)</span>
<span id="cb32-397"><a href="#cb32-397" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-398"><a href="#cb32-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-401"><a href="#cb32-401" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-402"><a href="#cb32-402" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb32-403"><a href="#cb32-403" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"genotypes_x"</span>))</span>
<span id="cb32-404"><a href="#cb32-404" aria-hidden="true" tabindex="-1"></a>  genotypes_x <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"output/genotypes_x.rds"</span>)</span>
<span id="cb32-405"><a href="#cb32-405" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-406"><a href="#cb32-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-407"><a href="#cb32-407" aria-hidden="true" tabindex="-1"></a><span class="fu">## Tidy data</span></span>
<span id="cb32-408"><a href="#cb32-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-409"><a href="#cb32-409" aria-hidden="true" tabindex="-1"></a>A strong point from *tidyGenR* is that variants and genotypes from <span class="in">`variant_call()`</span> and <span class="in">`genotype()`</span> are returned in <span class="in">`tidy`</span> format: one row per observation and variables in columns. Lets have a look at the data structure.</span>
<span id="cb32-410"><a href="#cb32-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-411"><a href="#cb32-411" aria-hidden="true" tabindex="-1"></a><span class="in">```{r glimpse_tidy_variants}</span></span>
<span id="cb32-412"><a href="#cb32-412" aria-hidden="true" tabindex="-1"></a><span class="co"># glimpse tidy variants</span></span>
<span id="cb32-413"><a href="#cb32-413" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="fu">head</span>(variants_x<span class="sc">$</span>ind_bs0))</span>
<span id="cb32-414"><a href="#cb32-414" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-415"><a href="#cb32-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-416"><a href="#cb32-416" aria-hidden="true" tabindex="-1"></a><span class="in">```{r glimpse_tidy_genotypes}</span></span>
<span id="cb32-417"><a href="#cb32-417" aria-hidden="true" tabindex="-1"></a><span class="co"># glimpse tidy genotypes</span></span>
<span id="cb32-418"><a href="#cb32-418" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="fu">head</span>(genotypes_x<span class="sc">$</span>ind_bs0))</span>
<span id="cb32-419"><a href="#cb32-419" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-420"><a href="#cb32-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-421"><a href="#cb32-421" aria-hidden="true" tabindex="-1"></a><span class="fu">## *tidyGenR* vs AmpliSAS</span></span>
<span id="cb32-422"><a href="#cb32-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-423"><a href="#cb32-423" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">AmpliSAS</span><span class="co">](https://doi.org/10.1111/1755-0998.12453)</span> is a software written in PERL with similar characteristics to *tidyGenR*. To compare their performance we run AmpliSAS in a docker container to genotype our raw sequences. The steps are detailed <span class="co">[</span><span class="ot">here</span><span class="co">](code/amplisas)</span>. AmpliSAS returns results in a multisheet EXCEL and in plain text files, one per locus. The function <span class="in">`amplisas2tidy()`</span> permits to read plain text results from AmpliSAS into tidy variants.</span>
<span id="cb32-424"><a href="#cb32-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-425"><a href="#cb32-425" aria-hidden="true" tabindex="-1"></a>Create input for AmpliSAS:</span>
<span id="cb32-426"><a href="#cb32-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-429"><a href="#cb32-429" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-430"><a href="#cb32-430" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb32-431"><a href="#cb32-431" aria-hidden="true" tabindex="-1"></a><span class="co"># amplicon metadata</span></span>
<span id="cb32-432"><a href="#cb32-432" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"code/amplisas/01_create_amplicon_data.R"</span>)</span>
<span id="cb32-433"><a href="#cb32-433" aria-hidden="true" tabindex="-1"></a><span class="co"># append barcodes to reads</span></span>
<span id="cb32-434"><a href="#cb32-434" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"code/amplisas/02_add_barcodes.R"</span>)</span>
<span id="cb32-435"><a href="#cb32-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-436"><a href="#cb32-436" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-437"><a href="#cb32-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-438"><a href="#cb32-438" aria-hidden="true" tabindex="-1"></a>AmpliSAS is run in a DOCKER container. The steps are detailed <span class="co">[</span><span class="ot">here</span><span class="co">](amplisas/benchmarking.md)</span>.</span>
<span id="cb32-439"><a href="#cb32-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-440"><a href="#cb32-440" aria-hidden="true" tabindex="-1"></a><span class="fu"># Integration of alleles with publised data</span></span>
<span id="cb32-441"><a href="#cb32-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-444"><a href="#cb32-444" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-445"><a href="#cb32-445" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-446"><a href="#cb32-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-447"><a href="#cb32-447" aria-hidden="true" tabindex="-1"></a><span class="fu"># session info</span></span>
<span id="cb32-448"><a href="#cb32-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-449"><a href="#cb32-449" aria-hidden="true" tabindex="-1"></a>Details on the sessionInfo() are <span class="co">[</span><span class="ot">here</span><span class="co">](session_info.txt)</span>:</span>
<span id="cb32-450"><a href="#cb32-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-453"><a href="#cb32-453" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-454"><a href="#cb32-454" aria-hidden="true" tabindex="-1"></a><span class="fu">writeLines</span>(<span class="fu">capture.output</span>(<span class="fu">sessionInfo</span>()), <span class="at">con =</span> <span class="st">"session_info.txt"</span>)</span>
<span id="cb32-455"><a href="#cb32-455" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>